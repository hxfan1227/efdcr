<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pre-Processing with efdcr • efdcr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Pre-Processing with efdcr">
<meta property="og:description" content="efdcr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164813355-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-164813355-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">efdcr</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/efdcr_intro.html">Introduction of efdcr</a>
    </li>
    <li>
      <a href="../articles/pre_process.html">Pre-Processing with efdcr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hxfan1227/efdcr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="pre_process_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Pre-Processing with efdcr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hxfan1227/efdcr/blob/master/vignettes/pre_process.Rmd"><code>vignettes/pre_process.Rmd</code></a></small>
      <div class="hidden name"><code>pre_process.Rmd</code></div>

    </div>

    
    
<div id="pre-process-with-efdcr" class="section level2">
<h2 class="hasAnchor">
<a href="#pre-process-with-efdcr" class="anchor"></a>Pre-process with <code>efdcr</code>
</h2>
<p>The time series data used by EEMS or EFDC is usually saved in <code>.wq</code> format, which is a text file with first line be the number of data points and the other lines be the time series data. The data lines will be repeated for all data points. Frankly, it is a simple and clear data structure but not tidy. Hence I design the <code><a href="../reference/dt_to_wq.html">dt_to_wq()</a></code> function to handle that issue.</p>
<div id="load-required-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#load-required-packages" class="anchor"></a>Load required packages</h3>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hxfan1227/efdcr">efdcr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://r-datatable.com">data.table</a></span><span class="op">)</span></pre></div>
</div>
<div id="hydrological-data" class="section level3">
<h3 class="hasAnchor">
<a href="#hydrological-data" class="anchor"></a>Hydrological Data</h3>
<p>Below is the <code>tidy</code> hydrological data, with <code>Date</code> column as the index. I suggest you store your hydrological data in this kind of format and then use the <code><a href="../reference/dt_to_wq.html">dt_to_wq()</a></code> function to convert it into <code>.wq</code> files.</p>
<pre><code>#&gt;          Date Ganjiang_Q Fuhe_Q Xinjiang_Q Raohe_Q Xiushui_Q
#&gt; 1: 1953-01-01        511   96.0       75.6    39.6  74.25928
#&gt; 2: 1953-01-02        625   84.0       69.3    40.6  76.54360
#&gt; 3: 1953-01-03        619   80.3       67.2    38.8  76.54360
#&gt; 4: 1953-01-04        591   75.2       63.0    36.8  71.97496
#&gt; 5: 1953-01-05        524   92.0       61.0    33.6  69.69064
#&gt; 6: 1953-01-06        480   88.0       57.0    34.8  69.69064</code></pre>
<p>Now we can convert it to <code>.wq</code> files.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="../reference/dt_to_wq.html">dt_to_wq</a></span><span class="op">(</span>measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ganjiang_Q'</span>, <span class="st">'Fuhe_Q'</span><span class="op">)</span>, src.dt <span class="op">=</span> <span class="va">hydro_data</span>, path <span class="op">=</span> <span class="st">'D:'</span>, 
         start.date <span class="op">=</span> <span class="st">'1953-01-01'</span>, end.date <span class="op">=</span> <span class="st">'1953-01-20'</span>, interval <span class="op">=</span> <span class="st">'1 day'</span><span class="op">)</span></pre></div>
<p>Then you will find 2 <code>.wq</code> files in your path (‘D:’ in this case). After that you can use the <code>import</code> button in EEMS when setting the boundaries. It will save you much time.</p>
</div>
<div id="water-quality-data" class="section level3">
<h3 class="hasAnchor">
<a href="#water-quality-data" class="anchor"></a>Water quality data</h3>
<p>Compared to other boundaires, prepare the water quality boundaries (i.e., cwqsrs01-21.inp) is the most trival thing when buidling a water enviroment model. However, the EEMS seems to have bugs in reading the water quality boundaies, i.e., it can not import the cwqsrsXX.inp files at once. Consequently, I come up with the <code><a href="../reference/set_wqbc.html">set_wqbc()</a></code> function. To use the <code><a href="../reference/set_wqbc.html">set_wqbc()</a></code> function, you should first convert your water quality data to <code>.wq</code> files with the <code><a href="../reference/dt_to_wq.html">dt_to_wq()</a></code> function. After that you may easily prepare the 21 input files required by EEMS.</p>
<p>When use the <code><a href="../reference/dt_to_wq.html">dt_to_wq()</a></code> function with water quality data, you should store your water quality data in the format below:</p>
<pre><code>#&gt;          Date     STN   DO    TP COD
#&gt; 1: 2010-01-12 Waizhou 11.6 0.054 1.9
#&gt; 2: 2010-01-12 Lijiadu 11.6 0.050 2.1
#&gt; 3: 2010-02-03 Waizhou 10.8 0.005 2.2
#&gt; 4: 2010-02-03 Lijiadu 10.5 0.042 3.6
#&gt; 5: 2010-03-12 Waizhou  9.7 0.035 2.3
#&gt; 6: 2010-04-14 Waizhou 10.2 0.081 3.2</code></pre>
<p>Then you can use the <code><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt()</a></code> and <code>dacast()</code> to rehshape your water quality into the prefered format:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">wq_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span>id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Date'</span>, <span class="st">'STN'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">~</span> <span class="va">variable</span> <span class="op">+</span> <span class="va">STN</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">wq_data</span></pre></div>
<pre><code>#&gt;          Date DO_Lijiadu DO_Waizhou TP_Lijiadu TP_Waizhou COD_Lijiadu
#&gt; 1: 2010-01-12       11.6       11.6      0.050      0.054         2.1
#&gt; 2: 2010-02-03       10.5       10.8      0.042      0.005         3.6
#&gt; 3: 2010-03-11        9.3         NA      0.085         NA         3.6
#&gt; 4: 2010-03-12         NA        9.7         NA      0.035          NA
#&gt; 5: 2010-04-13        8.7         NA      0.042         NA         4.6
#&gt; 6: 2010-04-14         NA       10.2         NA      0.081          NA
#&gt;    COD_Waizhou
#&gt; 1:         1.9
#&gt; 2:         2.2
#&gt; 3:          NA
#&gt; 4:         2.3
#&gt; 5:          NA
#&gt; 6:         3.2</code></pre>
<p>After that, you can use the <code><a href="../reference/dt_to_wq.html">dt_to_wq()</a></code> function to covert the water quality data into <code>.wq</code> files.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="../reference/dt_to_wq.html">dt_to_wq</a></span><span class="op">(</span>measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>, src.dt <span class="op">=</span> <span class="va">wq_data</span>, path <span class="op">=</span> <span class="st">'D:/wqs'</span>, 
         start.date <span class="op">=</span> <span class="st">'2010-01-01'</span>, end.date <span class="op">=</span> <span class="st">'2010-12-31'</span>, interval <span class="op">=</span> <span class="st">'1 day'</span><span class="op">)</span></pre></div>
<p>Then you will find 6 <code>.wq</code> files in your path (‘D:/wqs’ in this case). After that you can use the <code><a href="../reference/set_wqbc.html">set_wqbc()</a></code> function to generate the 21 cwqsrsXX.inp files.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="../reference/set_wqbc.html">set_wqbc</a></span><span class="op">(</span>wq_path <span class="op">=</span> <span class="st">'D:/wqs'</span>, cwqsrs_path <span class="op">=</span> <span class="st">'D:/'</span><span class="op">)</span></pre></div>
<p>Replace the original 21 cwqsrsXX.inp files with the new generated ones in your EFDC model folder. Reopen the EEMS project with the EEMS software, now the EEMS can read the new water quality boundaries.</p>
<p><strong>Note that the EFDC model can only model the 21 water quality variables below. And the <code>efdcr</code> package match the water qualiy boundaries with corresponding abbreviations</strong></p>
<table class="table">
<thead><tr class="header">
<th align="center">No.</th>
<th align="center">Full Names</th>
<th align="center">abbreviation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">1.</td>
<td align="center">Cyanobacteria</td>
<td align="center">Cyanobacteria</td>
</tr>
<tr class="even">
<td align="center">2.</td>
<td align="center">Diatoms</td>
<td align="center">Diatoms</td>
</tr>
<tr class="odd">
<td align="center">3.</td>
<td align="center">Green Algae</td>
<td align="center">GA</td>
</tr>
<tr class="even">
<td align="center">4.</td>
<td align="center">Refractory POC</td>
<td align="center">RPOC</td>
</tr>
<tr class="odd">
<td align="center">5.</td>
<td align="center">Labile POC</td>
<td align="center">LPOC</td>
</tr>
<tr class="even">
<td align="center">6.</td>
<td align="center">Dis Org Carbon</td>
<td align="center">DOC</td>
</tr>
<tr class="odd">
<td align="center">7.</td>
<td align="center">Ref Part Org Phosphorus</td>
<td align="center">RPOP</td>
</tr>
<tr class="even">
<td align="center">8.</td>
<td align="center">Lab Part Org Phosphorus</td>
<td align="center">LPOP</td>
</tr>
<tr class="odd">
<td align="center">9.</td>
<td align="center">Dis Org Phosphorus</td>
<td align="center">DOP</td>
</tr>
<tr class="even">
<td align="center">10.</td>
<td align="center">Total Phosphate</td>
<td align="center">TP</td>
</tr>
<tr class="odd">
<td align="center">11.</td>
<td align="center">Ref Part Org Nitrogen</td>
<td align="center">RPON</td>
</tr>
<tr class="even">
<td align="center">12.</td>
<td align="center">Lab Part Org Nitrogen</td>
<td align="center">LPON</td>
</tr>
<tr class="odd">
<td align="center">13.</td>
<td align="center">Dis Org Nitrogen</td>
<td align="center">DON</td>
</tr>
<tr class="even">
<td align="center">14.</td>
<td align="center">Ammonia Nitrogen</td>
<td align="center">NH4N</td>
</tr>
<tr class="odd">
<td align="center">15.</td>
<td align="center">Nitrate Nitrogen</td>
<td align="center">NO3N</td>
</tr>
<tr class="even">
<td align="center">16.</td>
<td align="center">Part Biogenic Silica</td>
<td align="center">PBS</td>
</tr>
<tr class="odd">
<td align="center">17.</td>
<td align="center">Dis Available Silica</td>
<td align="center">DAS</td>
</tr>
<tr class="even">
<td align="center">18.</td>
<td align="center">Chemical Oxygen Demand</td>
<td align="center">COD</td>
</tr>
<tr class="odd">
<td align="center">19.</td>
<td align="center">Dissolved Oxygen</td>
<td align="center">DO</td>
</tr>
<tr class="even">
<td align="center">20.</td>
<td align="center">Total Active Metal</td>
<td align="center">TAM</td>
</tr>
<tr class="odd">
<td align="center">21.</td>
<td align="center">Fecal Coliform</td>
<td align="center">FC</td>
</tr>
</tbody>
</table>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Hongxiang Fan, Guoyu Xu.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
